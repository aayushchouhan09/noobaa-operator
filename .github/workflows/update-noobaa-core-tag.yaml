name: Update Noobaa-Core container image tag

on:
  workflow_dispatch:
    inputs:
      container_image_tag:
        description: 'The container image tag for noobaa-core'
        required: true
      target_branch:
        description: 'The target branch to update the tag in'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-tag:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout master
        uses: actions/checkout@v4
        with:
          ref: master
      
      - name: Replace ContainerImageTag
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: 'ContainerImageTag = ".*"'
          replace: 'ContainerImageTag = "${{ github.event.inputs.container_image_tag }}"'
          include: 'pkg/options/options.go'
          regex: true
      
      - name: Commit & Push changes
        run: |
          git config --global user.email "github-action@noobaa.io"
          git config --global user.name "NooBaa GitHub Action"
          git checkout -b update-core-tag-${{ github.event.inputs.container_image_tag }}
          git diff
          git add pkg/options/options.go
          git commit -m "chore: update noobaa-core image tag to ${{ github.event.inputs.container_image_tag }}"
          git push origin update-core-tag-${{ github.event.inputs.container_image_tag }}

      - name: Create Pull Request
        id: create_pr
        run: |
          gh auth login --with-token <<< "${{ secrets.TOKEN_WRITE }}"
          echo "Creating PR with:"
          echo "  Title: Update ContainerImageTag to ${{ github.event.inputs.container_image_tag }}"
          echo "  Head: update-core-tag-${{ github.event.inputs.container_image_tag }}"
          echo "  Base: ${{ github.event.inputs.target_branch }}"
          # Create the PR and capture the URL from the output
          PR_OUTPUT=$(gh pr create \
            --title "Update ContainerImageTag to ${{ github.event.inputs.container_image_tag }}" \
            --body "Automated update of ContainerImageTag to ${{ github.event.inputs.container_image_tag }} in options.go" \
            --head update-core-tag-${{ github.event.inputs.container_image_tag }} \
            --base ${{ github.event.inputs.target_branch }})
          echo "PR create output: $PR_OUTPUT"
          PR_URL=$(echo "$PR_OUTPUT" | tail -1)
          if [[ ! "$PR_URL" =~ ^https://github\.com/.*/pull/[0-9]+$ ]]; then
            echo "First method failed, trying alternative method..."
            PR_URL=$(gh pr view update-core-tag-${{ github.event.inputs.container_image_tag }} --url)
          fi
          echo "Final PR URL: $PR_URL"
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      
      - name: Wait for PR checks and merge
        run: |
          gh auth login --with-token <<< "${{ secrets.TOKEN_WRITE }}"
          echo "Waiting for checks to pass on: ${{ steps.create_pr.outputs.pr_url }}"
          gh pr checks "${{ steps.create_pr.outputs.pr_url }}" --watch
          echo "Merging PR..."
          gh pr merge "${{ steps.create_pr.outputs.pr_url }}" --merge --admin --delete-branch
          echo "Workflow completed successfully!"
